/*
 *  Copyright 2026.  Baks.dev <admin@baks.dev>
 *
 *  Permission is hereby granted, free of charge, to any person obtaining a copy
 *  of this software and associated documentation files (the "Software"), to deal
 *  in the Software without restriction, including without limitation the rights
 *  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 *  copies of the Software, and to permit persons to whom the Software is furnished
 *  to do so, subject to the following conditions:
 *
 *  The above copyright notice and this permission notice shall be included in all
 *  copies or substantial portions of the Software.
 *
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 *  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 *  FITNESS FOR A PARTICULAR PURPOSE AND NON INFRINGEMENT. IN NO EVENT SHALL THE
 *  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 *  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 *  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 *  THE SOFTWARE.
 *
 */

var containers=document.querySelectorAll(".draggable-zone");let selectedProductSupplys=new Set;let status=null;let init_counter_T1dfEVi=100;setTimeout(function Hk91aSnRFfF(){if(typeof centrifuge!=="object"){if(init_counter_T1dfEVi>1e3){return}init_counter_T1dfEVi=init_counter_T1dfEVi*2;return setTimeout(Hk91aSnRFfF,init_counter_T1dfEVi)}const remove_channel=centrifuge.newSubscription("remove");remove_channel.on("publication",function(ctx){console.log(" ->",ctx);const supply=document.getElementById(ctx.data.supply);if(supply!==null){if(ctx.data.profile&&window.current_profile&&ctx.data.profile!==window.current_profile){supply.remove()}}}).subscribe();const supplys_channel=centrifuge.newSubscription("supplys");supplys_channel.on("publication",function(ctx){const supply=document.getElementById(ctx.data.supply);if(supply!==null){const number=supply.querySelector(".number-supply");const label=supply.querySelector(`label[for="${number.dataset.copy}"]`);let draggable=supply.querySelector('[class*="draggable"]');if(draggable!==null){if(ctx.data.lock===true){let draggableMove=draggable.querySelector(".bi-arrows-move");draggableMove.classList.add("d-none");let draggableLock=draggable.querySelector(".bi-ban");draggableLock.classList.remove("d-none");label?.classList.add("fade");draggable.classList.remove("draggable-handle");draggable.classList.add("draggable-lock");let lockMessage=`{\n                      "type": "danger",\n                      "header": "Поставка ${number.dataset.copy} в процессе обработки и не может быть изменена",\n                      "message": "${ctx.data.context}."\n                    }`;createToast(JSON.parse(lockMessage))}if(ctx.data.lock===false){let draggableLock=draggable.querySelector(".bi-ban");draggableLock.classList.add("d-none");let draggableMove=draggable.querySelector(".bi-arrows-move");draggableMove.classList.remove("d-none");label?.classList.remove("fade");draggable.classList.remove("draggable-lock");draggable.classList.add("draggable-handle");let unlockMessage=`{\n                      "type": "success",\n                      "header": "Поставка ${number.dataset.copy} готова к изменению",\n                      "message": "${ctx.data.context}."\n                    }`;createToast(JSON.parse(unlockMessage));return}}}}).subscribe()},100);executeFunc(function lW9JEBic(){if(typeof Droppable!=="object"||typeof bootstrap!=="object"){return false}const modal=document.getElementById("modal");const modal_bootstrap=bootstrap.Modal.getOrCreateInstance(modal);let droppable;let droppableOrigin;let droppableLevel;let droppableRestrict;let toDroppable;let isDraggingSelected=false;let draggedOrderIds=[];function initializeDroppable(){if(droppable){droppable.destroy()}containers=document.querySelectorAll(".draggable-zone");droppable=new Droppable.default(containers,{draggable:".draggable",dropzone:".draggable-zone",handle:".draggable .draggable-handle",mirror:{appendTo:"body"}});droppable.on("drag:over:container",e=>{let status=e.overContainer.dataset.status;if(droppableLevel!==status){droppableLevel=status}});droppable.on("drag:start",e=>{document.body.style.overflow="hidden";const draggedOrderId=e.originalSource.id;if(selectedProductSupplys.has(draggedOrderId)&&selectedProductSupplys.size>1){isDraggingSelected=true;draggedOrderIds=Array.from(selectedProductSupplys);const indicator=createMultipleDragIndicator(selectedProductSupplys.size);e.originalSource.appendChild(indicator);selectedProductSupplys.forEach(supplyId=>{const element=document.getElementById(supplyId);if(element&&element!==e.originalSource){if(element.id!==draggedOrderId){element.classList.add("d-none")}}})}else{isDraggingSelected=false;draggedOrderIds=[draggedOrderId];document.querySelectorAll(".draggable").forEach(draggable=>{if(draggable.id!==draggedOrderId){draggable.classList.add("opacity-50")}else{draggable.classList.replace("z-0","z-2")}})}});droppable.on("drag:over",e=>{droppableLevel=e.overContainer.getAttribute("data-status")});droppable.on("drag:stop",async e=>{const indicator=e.originalSource.querySelector(".multiple-drag-indicator");if(indicator){indicator.remove()}document.querySelectorAll(".draggable").forEach(draggable=>{draggable.classList.remove("opacity-50");draggable.classList.replace("z-2","z-0")});containers.forEach(c=>{c.classList.remove("draggable-dropzone--occupied")});document.body.style.overflow="auto";let sourceLevel=e.sourceContainer.dataset.status;if(sourceLevel!==droppableLevel&&droppableRestrict!=="restricted"){let supplysToProcess=[];if(isDraggingSelected&&draggedOrderIds.length>1){supplysToProcess=draggedOrderIds}else{supplysToProcess=[e.originalSource.id]}console.log(`Из статуса ${sourceLevel} в статус ${droppableLevel}`);modal.innerHTML='<div class="modal-dialog modal-dialog-centered"><div class="d-flex justify-content-center w-100"><div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div></div></div>';modal_bootstrap.show();try{let formData=new FormData;supplysToProcess.forEach((id,index)=>{formData.append(`${droppableLevel}_product_supply_form[supplys][${index}][id]`,id)});const url="/admin/products/supply/"+droppableLevel;console.log(`Вызов ${url}`);const response=await fetch(url,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:formData});if(response.status===302||response.status===404){formData=new FormData;supplysToProcess.forEach((id,index)=>{formData.append(`product_supplys_form[supplys][${index}][id]`,id)});let status_url="/admin/products/supply/status/";let status_url_param=droppableLevel;console.log(`response ${response.status} ->  Вызов url ${status_url} со статусом ${status_url_param}`);const status_request=await fetch(status_url+status_url_param,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:formData}).then(response=>response.json());let status_response=await status_request;selectedProductSupplys.clear();updateMultiSelectedVisualForProductsSupply();modal_bootstrap.hide();if(status_response.status===400){createToast(JSON.parse(`{ "type":"${status_response.type}" , `+`"header" : "${status_response.header}"  , `+`"message" : "${status_response.message}" }`));return}createToast(JSON.parse(`{ "type":"${status_response.type}" , `+`"header" : "${status_response.header}"  , `+`"message" : "${status_response.message}" }`));return}if(response.status===400){selectedProductSupplys.clear();updateMultiSelectedVisualForProductsSupply();modal_bootstrap.hide();let $dangerOrderToast='{ "type":"danger" , '+'"header":"Изменение статуса поставок"  , '+'"message" : "Невозможно изменить статус" }';createToast(JSON.parse($dangerOrderToast));return}if(response.status===200){const result=await response.text();selectedProductSupplys.clear();updateMultiSelectedVisualForProductsSupply();modal.innerHTML=result;let lazy=document.createElement("script");lazy.src="/assets/"+$version+"/js/lazyload.min.js";document.head.appendChild(lazy)}else{throw new Error(`Unexpected status code ${response.status}`)}}catch(error){modal_bootstrap.hide();selectedProductSupplys.clear();updateMultiSelectedVisualForProductsSupply();console.error("Ошибка обновления:",error);let $dangerOrderToast='{ "type":"danger" , '+'"header":"Ошибка сети"  , '+'"message" : "Ошибка при отправке запроса на сервер!" }';createToast(JSON.parse($dangerOrderToast))}}isDraggingSelected=false;draggedOrderIds=[];setTimeout(initializeDroppable,0)});droppable.on("droppable:dropped",e=>{droppableRestrict=e.dropzone.dataset.level;if(droppableRestrict==="restricted"){e.cancel()}})}initMultiSelectForProductsSupply();updateMultiSelectedVisualForProductsSupply();initializeDroppable();return true});function initMultiSelectForProductsSupply(){const all=document.getElementById("check-all");const checkboxes=document.querySelectorAll('.draggable input[type="checkbox"]');checkboxes.forEach(checkbox=>{checkbox.checked=false;checkbox.addEventListener("change",function(){const selectedId=this.closest(".draggable").id;const draggableElement=this.closest(".draggable");status=checkbox.dataset.status;if(this.checked){selectedProductSupplys.add(selectedId);draggableElement.classList.add("muilti-selected")}else{selectedProductSupplys.delete(selectedId);draggableElement.classList.remove("muilti-selected")}updateMultiSelectedVisualForProductsSupply()})});if(all){all.checked=false;all.addEventListener("change",function(all){checkboxes.forEach(checkbox=>{if(checkbox.dataset.status==="new"){const selectedId=checkbox.closest(".draggable").id;const draggableElement=checkbox.closest(".draggable");checkbox.checked=this.checked;if(this.checked){selectedProductSupplys.add(selectedId);draggableElement.classList.add("muilti-selected")}else{selectedProductSupplys.delete(selectedId);draggableElement.classList.remove("muilti-selected")}}});updateMultiSelectedVisualForProductsSupply()})}}function updateMultiSelectedVisualForProductsSupply(){const allDraggables=document.querySelectorAll(".draggable");allDraggables.forEach(draggable=>{const selectedId=draggable.id;const draggableHandle=draggable.querySelector(".draggable-handle");const draggableCheckbox=draggable.querySelector('input[type="checkbox"]');if(selectedProductSupplys.has(selectedId)){draggable.classList.remove("opacity-50");draggable.classList.replace("z-0","z-2");draggable.style.transform="scale(0.98)";draggable.style.boxShadow="0 0 0 2px #007bff";if(draggableHandle){draggableHandle.style.pointerEvents="auto"}}else{draggable.removeAttribute("style");if(draggableHandle){if(selectedProductSupplys.size>0){draggable.classList.add("opacity-50");draggableHandle.style.pointerEvents="none";if(draggableCheckbox&&draggableCheckbox.dataset.status!==status){draggableCheckbox.disabled=true}}if(selectedProductSupplys.size===0){draggable.classList.remove("opacity-50");draggableHandle.style.pointerEvents="auto";draggableCheckbox?draggableCheckbox.disabled=false:false;status=null}}}})}function createMultipleDragIndicator(count){const indicator=document.createElement("div");indicator.className="multiple-drag-indicator";indicator.style.cssText=`\n            position: absolute;\n            top: -10px;\n            right: -10px;\n            background: #007bff;\n            color: white;\n            border-radius: 50%;\n            width: 24px;\n            height: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 12px;\n            font-weight: bold;\n            z-index: 1000;\n        `;indicator.textContent=count;return indicator}